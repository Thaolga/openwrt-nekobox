<%#
    Spectra is a clean HTML5 theme for LuCI. It is based on luci-theme-material Argon Template
    luci-theme-spectra
    Copyright 2020 Jerrykuku <jerrykuku@qq.com>
    Have a bug? Please create an issue here on GitHub!
    https://github.com/jerrykuku/luci-theme-spectra/issues
    luci-theme-material:
    Copyright 2015 Lutty Yang <lutty@wcan.in>
    Agron Theme
    https://demos.creative-tim.com/spectra-dashboard/index.html
    Licensed to the public under the Apache License 2.0
-%>

<% local ver = require("luci.version") %>
</div>
<footer class="mobile-hide" style="display: none;">
    <a href="https://github.com/openwrt/luci" class="powered-by" target="_blank" rel="noopener noreferrer">Powered by <%= ver.luciname %> (<%= ver.luciversion %>)</a> / <a href="https://github.com/openwrt/openwrt" target="_blank" class="version" rel="noopener noreferrer"><%= ver.distversion %></a>
    <ul class="breadcrumb pull-right" id="modemenu" style="display:none"></ul>
</footer>
</div>
</div>
<div id="tempcpu"></div>
<div id="cpuusage"></div>
<script>
    var luciLocation = <%= luci.http.write_json(luci.dispatcher.context.path) %>;
    var winHeight = $(window).height();
    $(window).resize(function () {
        var winWidth = $(window).width();
        if (winWidth < 600) {
            var newHeight = $(this).height();
            var keyboradHeight = newHeight - winHeight;
            $(".ftc").css("bottom", keyboradHeight + 30);
        }
    });
</script>
<script type="text/javascript">L.require('menu-spectra')</script>
<script>
    window.addEventListener('load', function() {
        setTimeout(function() {
            const footer = document.querySelector('footer.mobile-hide');
            if (footer) {
                footer.style.display = 'block';
            }
        }, 800);
    });
</script>
<script>
function convertEmojiToCountryCode(emoji) {
    if (!emoji) return '';
    emoji = emoji.replace(/\uFE0F/g, '');
    const emojiToCountryCodeMap = {
        'ðŸ‡­ðŸ‡°':'hk','ðŸ‡ºðŸ‡¸':'us','ðŸ‡¯ðŸ‡µ':'jp','ðŸ‡¸ðŸ‡¬':'sg','ðŸ‡«ðŸ‡®':'fi','ðŸ‡©ðŸ‡ª':'de',
        'ðŸ‡¨ðŸ‡³':'cn','ðŸ‡¹ðŸ‡¼':'tw','ðŸ‡²ðŸ‡´':'mo','ðŸ‡°ðŸ‡·':'kr','ðŸ‡²ðŸ‡¾':'my','ðŸ‡®ðŸ‡©':'id',
        'ðŸ‡µðŸ‡­':'ph','ðŸ‡»ðŸ‡³':'vn','ðŸ‡¹ðŸ‡­':'th','ðŸ‡®ðŸ‡³':'in','ðŸ‡¬ðŸ‡§':'gb','ðŸ‡«ðŸ‡·':'fr',
        'ðŸ‡®ðŸ‡¹':'it','ðŸ‡ªðŸ‡¸':'es','ðŸ‡µðŸ‡¹':'pt','ðŸ‡³ðŸ‡±':'nl','ðŸ‡§ðŸ‡ª':'be','ðŸ‡¸ðŸ‡ª':'se',
        'ðŸ‡³ðŸ‡´':'no','ðŸ‡©ðŸ‡°':'dk','ðŸ‡·ðŸ‡º':'ru','ðŸ‡ºðŸ‡¦':'ua','ðŸ‡µðŸ‡±':'pl','ðŸ‡¨ðŸ‡¿':'cz',
        'ðŸ‡­ðŸ‡º':'hu','ðŸ‡·ðŸ‡´':'ro','ðŸ‡¬ðŸ‡·':'gr','ðŸ‡§ðŸ‡¬':'bg','ðŸ‡¹ðŸ‡·':'tr','ðŸ‡¸ðŸ‡¦':'sa',
        'ðŸ‡¦ðŸ‡ª':'ae','ðŸ‡®ðŸ‡±':'il','ðŸ‡ªðŸ‡¬':'eg','ðŸ‡¿ðŸ‡¦':'za','ðŸ‡³ðŸ‡¬':'ng','ðŸ‡§ðŸ‡·':'br',
        'ðŸ‡¦ðŸ‡·':'ar','ðŸ‡²ðŸ‡½':'mx','ðŸ‡¨ðŸ‡±':'cl','ðŸ‡¨ðŸ‡´':'co','ðŸ‡µðŸ‡ª':'pe','ðŸ‡»ðŸ‡ª':'ve',
        'ðŸ‡¦ðŸ‡º':'au','ðŸ‡³ðŸ‡¿':'nz','ðŸ‡¨ðŸ‡¦':'ca','ðŸ‡®ðŸ‡ª':'ie','ðŸ‡¨ðŸ‡­':'ch','ðŸ‡¦ðŸ‡¹':'at',
        'ðŸ‡±ðŸ‡º':'lu','ðŸ‡®ðŸ‡¸':'is','ðŸ‡±ðŸ‡»':'lv','ðŸ‡±ðŸ‡¹':'lt','ðŸ‡ªðŸ‡ª':'ee'
    };
    return emojiToCountryCodeMap[emoji] || '';
}

function convertTablesToCards() {
    const activeContainer = document.querySelector('.cbi-tabcontainer[style*="display: block"], .cbi-tabcontainer[style*="display:block"]');
    if (!activeContainer) return;
    if (activeContainer.getAttribute('data-cards-converted') === 'true') return;
    const table = activeContainer.querySelector('.cbi-section-table');
    if (!table) return;
    const rows = table.querySelectorAll('.cbi-section-table-row');
    if (rows.length === 0) return;
    const cardsContainer = document.createElement('div');
    cardsContainer.className = 'cards-container';
    rows.forEach((row) => {
        const card = document.createElement('div');
        card.className = 'node-card';
        if (row.classList.contains('_now_use_bg')) {
            card.classList.add('_now_use_bg');
        }
        const tds = row.querySelectorAll('td');
        const remarks = tds[0]?.innerHTML || '';
        const ping = tds[1]?.innerHTML || '';
        const tcping = tds[2]?.innerHTML || '';
        const urlTest = tds[3]?.innerHTML || '';
        const actions = tds[4]?.innerHTML || '';
        const remarksSpan = tds[0]?.querySelector('span, div, a');
        let remarksClass = '';
        if (remarksSpan && remarksSpan.classList.contains('_now_use')) {
            remarksClass = '_now_use';
        }
        const emojiRegex = /[\u{1F1E6}-\u{1F1FF}]{2}/gu;
        const countryEmoji = remarks.match(emojiRegex)?.[0];
        const countryCode = convertEmojiToCountryCode(countryEmoji) || '';
        const flagUrl = countryCode ? `/luci-static/ipip/flags/${countryCode}.png` : '';
        card.innerHTML = `
            <div class="card-header ${remarksClass}">
                ${flagUrl ? `<div class="card-flag" style="background-image: url('${flagUrl}');"></div>` : ''}
                ${remarks}
            </div>
            <div class="card-metrics">
                <div class="metric-item">Ping: ${ping}</div>
                <div class="metric-item">TCPing: ${tcping}</div>
                <div class="metric-item">URL: ${urlTest}</div>
            </div>
            <div class="card-actions">${actions}</div>
        `;
        cardsContainer.appendChild(card);
    });
    table.parentNode.insertBefore(cardsContainer, table);
    activeContainer.setAttribute('data-cards-converted', 'true');
}

function initAllTabs() {
    const allContainers = document.querySelectorAll('.cbi-tabcontainer');
    allContainers.forEach((container) => {
        container.removeAttribute('data-cards-converted');
        const oldCards = container.querySelector('.cards-container');
        if (oldCards) {
            oldCards.remove();
        }
    });
    convertTablesToCards();
}

document.addEventListener('DOMContentLoaded', function() {
    setTimeout(initAllTabs, 100);
});

document.addEventListener('click', function(e) {
    const tabLink = e.target.closest('.cbi-tab');
    if (tabLink && tabLink.querySelector('a')) {
        setTimeout(initAllTabs, 200);
    }
});

const observer = new MutationObserver(function(mutations) {
    mutations.forEach(function(mutation) {
        if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
            const target = mutation.target;
            if (target.classList.contains('cbi-tabcontainer') && target.style.display.includes('block')) {
                setTimeout(initAllTabs, 100);
            }
        }
    });
});

observer.observe(document.body, {
    attributes: true,
    subtree: true,
    attributeFilter: ['style']
});
</script>

</body>
</html>
