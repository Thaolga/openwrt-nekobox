<%#
    Spectra is a clean HTML5 theme for LuCI. It is based on luci-theme-material Argon Template
    luci-theme-spectra
    Copyright 2020 Jerrykuku <jerrykuku@qq.com>
    Have a bug? Please create an issue here on GitHub!
    https://github.com/jerrykuku/luci-theme-spectra/issues
    luci-theme-material:
    Copyright 2015 Lutty Yang <lutty@wcan.in>
    Agron Theme
    https://demos.creative-tim.com/spectra-dashboard/index.html
    Licensed to the public under the Apache License 2.0
-%>

<% local ver = require("luci.version") %>
</div>
<footer class="mobile-hide" style="display: none;">
    <a href="https://github.com/openwrt/luci" class="powered-by" target="_blank" rel="noopener noreferrer">Powered by <%= ver.luciname %> (<%= ver.luciversion %>)</a> / <a href="https://github.com/openwrt/openwrt" target="_blank" class="version" rel="noopener noreferrer"><%= ver.distversion %></a>
    <ul class="breadcrumb pull-right" id="modemenu" style="display:none"></ul>
</footer>
</div>
</div>
<div id="tempcpu"></div>
<div id="cpuusage"></div>
<script>
    var luciLocation = <%= luci.http.write_json(luci.dispatcher.context.path) %>;
    var winHeight = $(window).height();
    $(window).resize(function () {
        var winWidth = $(window).width();
        if (winWidth < 600) {
            var newHeight = $(this).height();
            var keyboradHeight = newHeight - winHeight;
            $(".ftc").css("bottom", keyboradHeight + 30);
        }
    });
</script>
<script type="text/javascript">L.require('menu-spectra')</script>
<script>
    window.addEventListener('load', function() {
        setTimeout(function() {
            const footer = document.querySelector('footer.mobile-hide');
            if (footer) {
                footer.style.display = 'block';
            }
        }, 800);
    });
</script>

<script>
const countryMap = {
    '阿富汗': '🇦🇫', '阿尔巴尼亚': '🇦🇱', '阿尔及利亚': '🇩🇿', '阿根廷': '🇦🇷', '阿曼': '🇴🇲',
    '阿塞拜疆': '🇦🇿', '爱尔兰': '🇮🇪', '埃及': '🇪🇬', '埃塞俄比亚': '🇪🇹', '澳大利亚': '🇦🇺',
    '奥地利': '🇦🇹', '巴巴多斯': '🇧🇧', '巴哈马': '🇧🇸', '巴基斯坦': '🇵🇰', '巴拿马': '🇵🇦',
    '巴布亚新几内亚': '🇵🇬', '巴拉圭': '🇵🇾', '巴林': '🇧🇭', '巴西': '🇧🇷', '白俄罗斯': '🇧🇾',
    '保加利亚': '🇧🇬', '北马里亚纳群岛': '🇲🇵', '比利时': '🇧🇪', '冰岛': '🇮🇸', '波兰': '🇵🇱',
    '波多黎各': '🇵🇷', '玻利维亚': '🇧🇴', '博茨瓦纳': '🇧🇼', '丹麦': '🇩🇰', '德国': '🇩🇪',
    '东帝汶': '🇹🇱', '多哥': '🇹🇬', '多米尼加': '🇩🇴', '厄瓜多尔': '🇪🇨', '厄立特里亚': '🇪🇷',
    '法国': '🇫🇷', '法罗群岛': '🇫🇴', '法属圭亚那': '🇬🇫', '芬兰': '🇫🇮', '菲律宾': '🇵🇭',
    '福克兰群岛': '🇫🇰', '冈比亚': '🇬🇲', '刚果（布）': '🇨🇬', '刚果（金）': '🇨🇩', '哥伦比亚': '🇨🇴',
    '哥斯达黎加': '🇨🇷', '格鲁吉亚': '🇬🇪', '格林纳达': '🇬🇩', '关岛': '🇬🇺', '瓜德罗普': '🇬🇵',
    '哈萨克斯坦': '🇰🇿', '海地': '🇭🇹', '韩国': '🇰🇷', '荷兰': '🇳🇱', '荷兰加勒比': '🇧🇶',
    '黑山': '🇲🇪', '洪都拉斯': '🇭🇳', '基里巴斯': '🇰🇮', '吉布提': '🇩🇯', '几内亚': '🇬🇳',
    '几内亚比绍': '🇬🇼', '加拿大': '🇨🇦', '加蓬': '🇬🇦', '柬埔寨': '🇰🇭', '捷克': '🇨🇿',
    '津巴布韦': '🇿🇼', '卡塔尔': '🇶🇦', '喀麦隆': '🇨🇲', '科摩罗': '🇰🇲', '科索沃': '🇽🇰',
    '科威特': '🇰🇼', '肯尼亚': '🇰🇪', '拉脱维亚': '🇱🇻', '莱索托': '🇱🇸', '黎巴嫩': '🇱🇧',
    '利比里亚': '🇱🇷', '利比亚': '🇱🇾', '列支敦士登': '🇱🇮', '立陶宛': '🇱🇹', '卢森堡': '🇱🇺',
    '毛里塔尼亚': '🇲🇷', '马达加斯加': '🇲🇬', '马拉维': '🇲🇼', '马来西亚': '🇲🇾', '马尔代夫': '🇲🇻',
    '马里': '🇲🇱', '马耳他': '🇲🇹', '马绍尔群岛': '🇲🇭', '马提尼克': '🇲🇶', '毛里求斯': '🇲🇺',
    '蒙古': '🇲🇳', '美国': '🇺🇸', '美属维尔京群岛': '🇻🇮', '密克罗尼西亚': '🇫🇲', '缅甸': '🇲🇲',
    '南非': '🇿🇦', '南苏丹': '🇸🇸', '尼泊尔': '🇳🇵', '尼日尔': '🇳🇪', '尼日利亚': '🇳🇬',
    '挪威': '🇳🇴', '诺福克岛': '🇳🇫', '帕劳': '🇵🇼', '葡萄牙': '🇵🇹', '日本': '🇯🇵',
    '瑞典': '🇸🇪', '瑞士': '🇨🇭', '萨尔瓦多': '🇸🇻', '塞尔维亚': '🇷🇸', '塞拉利昂': '🇸🇱',
    '塞舌尔': '🇸🇨', '沙特阿拉伯': '🇸🇦', '圣基茨和尼维斯': '🇰🇳', '圣卢西亚': '🇱🇨', '圣马力诺': '🇸🇲',
    '圣多美和普林西比': '🇸🇹', '圣文森特和格林纳丁斯': '🇻🇨', '斯里兰卡': '🇱🇰', '斯洛伐克': '🇸🇰',
    '斯洛文尼亚': '🇸🇮', '斯威士兰': '🇸🇿', '所罗门群岛': '🇸🇧', '苏丹': '🇸🇩', '苏里南': '🇸🇷',
    '台湾': '🇹🇼', '坦桑尼亚': '🇹🇿', '泰国': '🇹🇭', '汤加': '🇹🇴', '土耳其': '🇹🇷',
    '土库曼斯坦': '🇹🇲', '突尼斯': '🇹🇳', '图瓦卢': '🇹🇻', '瓦努阿图': '🇻🇺', '危地马拉': '🇬🇹',
    '乌干达': '🇺🇬', '乌克兰': '🇺🇦', '乌拉圭': '🇺🇾', '乌兹别克斯坦': '🇺🇿', '西班牙': '🇪🇸',
    '希腊': '🇬🇷', '新加坡': '🇸🇬', '新喀里多尼亚': '🇳🇨', '新西兰': '🇳🇿', '匈牙利': '🇭🇺',
    '叙利亚': '🇸🇾', '牙买加': '🇯🇲', '伊朗': '🇮🇷', '伊拉克': '🇮🇶', '意大利': '🇮🇹',
    '以色列': '🇮🇱', '印度': '🇮🇳', '印度尼西亚': '🇮🇩', '英国': '🇬🇧', '约旦': '🇯🇴',
    '泽西': '🇯🇪', '赞比亚': '🇿🇲', '乍得': '🇹🇩', '智利': '🇨🇱', '中非共和国': '🇨🇫',
    '中国': '🇨🇳', '直布罗陀': '🇬🇮', '台湾': '🇹🇼', '朱诺': '🇯🇪', '香港': '🇭🇰', '澳门': '🇲🇴',
    '安道尔': '🇦🇩', '安哥拉': '🇦🇴', '安提瓜和巴布达': '🇦🇬', '亚美尼亚': '🇦🇲', '孟加拉国': '🇧🇩',
    '伯利兹': '🇧🇿', '贝宁': '🇧🇯', '不丹': '🇧🇹', '波斯尼亚和黑塞哥维那': '🇧🇦', '文莱': '🇧🇳',
    '布基纳法索': '🇧🇫', '布隆迪': '🇧🇮', '佛得角': '🇨🇻', '哥斯达黎加': '🇨🇷', '科特迪瓦': '🇨🇮',
    '克罗地亚': '🇭🇷', '古巴': '🇨🇺', '塞浦路斯': '🇨🇾', '多米尼克': '🇩🇲', '多明尼加共和国': '🇩🇴',
    '萨尔瓦多': '🇸🇻', '赤道几内亚': '🇬🇶', '厄立特里亚': '🇪🇷', '爱沙尼亚': '🇪🇪', '斐济': '🇫🇯',
    '加纳': '🇬🇭', '格林纳达': '🇬🇩', '圭亚那': '🇬🇾', '洪都拉斯': '🇭🇳', '冰岛': '🇮🇸',
    '约旦': '🇯🇴', '肯尼亚': '🇰🇪', '基里巴斯': '🇰🇮', '科威特': '🇰🇼', '吉尔吉斯斯坦': '🇰🇬',
    '老挝': '🇱🇦', '拉脱维亚': '🇱🇻', '黎巴嫩': '🇱🇧', '莱索托': '🇱🇸', '利比里亚': '🇱🇷',
    '利比亚': '🇱🇾', '列支敦士登': '🇱🇮', '立陶宛': '🇱🇹', '卢森堡': '🇱🇺', '马达加斯加': '🇲🇬',
    '马拉维': '🇲🇼', '马来西亚': '🇲🇾', '马尔代夫': '🇲🇻', '马里': '🇲🇱', '马耳他': '🇲🇹',
    '马绍尔群岛': '🇲🇭', '毛里塔尼亚': '🇲🇷', '毛里求斯': '🇲🇺', '墨西哥': '🇲🇽', '密克罗尼西亚': '🇫🇲',
    '摩尔多瓦': '🇲🇩', '摩纳哥': '🇲🇨', '蒙古': '🇲🇳', '黑山': '🇲🇪', '摩洛哥': '🇲🇦',
    '莫桑比克': '🇲🇿', '缅甸': '🇲🇲', '纳米比亚': '🇳🇦', '瑙鲁': '🇳🇷', '尼泊尔': '🇳🇵',
    '荷兰': '🇳🇱', '新西兰': '🇳🇿', '尼加拉瓜': '🇳🇮', '尼日尔': '🇳🇪', '尼日利亚': '🇳🇬',
    '北马其顿': '🇲🇰', '挪威': '🇳🇴', '阿曼': '🇴🇲', '巴基斯坦': '🇵🇰', '帕劳': '🇵🇼',
    '巴拿马': '🇵🇦', '巴布亚新几内亚': '🇵🇬', '巴拉圭': '🇵🇾', '秘鲁': '🇵🇪', '菲律宾': '🇵🇭',
    '波兰': '🇵🇱', '葡萄牙': '🇵🇹', '卡塔尔': '🇶🇦', '罗马尼亚': '🇷🇴', '俄罗斯联邦': '🇷🇺',
    '卢旺达': '🇷🇼', '圣基茨和尼维斯': '🇰🇳', '圣卢西亚': '🇱🇨', '圣文森特和格林纳丁斯': '🇻🇨', '萨摩亚': '🇼🇸',
    '圣马力诺': '🇸🇲', '圣多美和普林西比': '🇸🇹', '沙特阿拉伯': '🇸🇦', '塞内加尔': '🇸🇳', '塞尔维亚': '🇷🇸',
    '塞舌尔': '🇸🇨', '塞拉利昂': '🇸🇱', '新加坡': '🇸🇬', '斯洛伐克': '🇸🇰', '斯洛文尼亚': '🇸🇮',
    '所罗门群岛': '🇸🇧', '索马里': '🇸🇴', '南非': '🇿🇦', '韩国': '🇰🇷', '南苏丹': '🇸🇸',
    '西班牙': '🇪🇸', '斯里兰卡': '🇱🇰', '苏丹': '🇸🇩', '苏里南': '🇸🇷', '瑞典': '🇸🇪',
    '瑞士': '🇨🇭', '叙利亚': '🇸🇾', '塔吉克斯坦': '🇹🇯', '坦桑尼亚': '🇹🇿', '泰国': '🇹🇭',
    '东帝汶': '🇹🇱', '多哥': '🇹🇬', '汤加': '🇹🇴', '特立尼达和多巴哥': '🇹🇹', '突尼斯': '🇹🇳',
    '土耳其': '🇹🇷', '土库曼斯坦': '🇹🇲', '图瓦卢': '🇹🇻', '乌干达': '🇺🇬', '乌克兰': '🇺🇦',
    '阿拉伯联合酋长国': '🇦🇪', '英国': '🇬🇧', '美国': '🇺🇸', '乌拉圭': '🇺🇾', '乌兹别克斯坦': '🇺🇿',
    '瓦努阿图': '🇻🇺', '委内瑞拉': '🇻🇪', '越南': '🇻🇳', '也门': '🇾🇪', '赞比亚': '🇿🇲',
    '津巴布韦': '🇿🇼'
};

function addFlagIfMissing(titleText) {
    if (/[\u{1F1E6}-\u{1F1FF}]{2}/u.test(titleText)) return titleText;
    for (const name in countryMap) {
        if (titleText.includes(name)) return countryMap[name] + ' ' + titleText;
    }
    return titleText;
}

function wrapEmojiWithSpan(text) {
    return text.replace(/([\u{1F1E6}-\u{1F1FF}]{2})/gu, '<span class="flag">$1</span>');
}

function extractProtocolFromTitle(titleText) {
    const match = titleText.match(/^([^\s：]+)\s*([^\s：]+)：\s*([\s\S]*)$/);
    if (!match) return { protocol: '', actualTitle: titleText };
    return { protocol: match[2], actualTitle: match[3] || '' };
}

function getNodeTypeFromTitle(titleText) {
    if (titleText.includes('Sing-Box')) return 'Sing-Box';
    if (titleText.includes('Xray')) return 'Xray';
    return '';
}

function getProtocolBadge(protocol) {
    const badgeColors = {
        HY2: '#ff6b6b', HY: '#ffa726', VMess: '#42a5f5', VLESS: '#5c6bc0',
        SS: '#66bb6a', SSR: '#4caf50', WG: '#ab47bc', Trojan: '#ff69b4',
        URLTest: '#7e57c2', Balancing: '#ef5350', Shunt: '#26a69a'
    };
    const badgeTexts = {
        HY2: 'HY2', HY: 'HY', VMess: 'VMess', VLESS: 'VLESS', SS: 'SS',
        SSR: 'SSR', WG: 'WG', Trojan: 'Trojan', URLTest: 'Test',
        Balancing: 'Balance', Shunt: 'Shunt'
    };
    const color = badgeColors[protocol] || '#000';
    const text = badgeTexts[protocol] || protocol;
    return `<span class="card-badge" style="background-color:${color}">${text}</span>`;
}

function convertTablesToCards() {
    const activeContainer = document.querySelector(
        '.cbi-tabcontainer[style*="display: block"], .cbi-tabcontainer[style*="display:block"]'
    );
    if (!activeContainer) return;
    if (activeContainer.dataset.cardsConverted === 'true') return;

    const table = activeContainer.querySelector('.cbi-section-table');
    if (!table) return;

    const rows = table.querySelectorAll('.cbi-section-table-row');
    if (!rows.length) return;

    const cardsContainer = document.createElement('div');
    cardsContainer.className = 'cards-container';

    rows.forEach(row => {
        const card = document.createElement('div');
        card.className = 'node-card';

        if (row.classList.contains('_now_use_bg')) card.classList.add('_now_use_bg');

        const tds = row.querySelectorAll('td');
        const originalTitle = tds[0]?.textContent || '';
        const ping = tds[1]?.innerHTML || '';
        const tcping = tds[2]?.innerHTML || '';
        const urlTest = tds[3]?.innerHTML || '';
        const actions = tds[4]?.innerHTML || '';

        const remarksSpan = tds[0]?.querySelector('span, div, a');
        const remarksClass = remarksSpan?.classList.contains('_now_use') ? '_now_use' : '';

        const { protocol, actualTitle } = extractProtocolFromTitle(originalTitle);
        const nodeType = getNodeTypeFromTitle(originalTitle);

        const titleWithFlag = addFlagIfMissing(actualTitle);
        const badgeHtml = protocol ? getProtocolBadge(protocol) : '';

        card.innerHTML = `
            <div class="card-header ${remarksClass}">
                ${wrapEmojiWithSpan(titleWithFlag)}
                ${badgeHtml}
            </div>
            <div class="card-metrics">
                <div class="metric-item">Ping: ${ping}</div>
                <div class="metric-item">TCPing: ${tcping}</div>
                <div class="metric-item">URL: ${urlTest}</div>
            </div>
            <div class="card-actions">${actions}</div>
        `;

        if (nodeType) card.title = nodeType;

        cardsContainer.appendChild(card);
    });

    table.parentNode.insertBefore(cardsContainer, table);
    activeContainer.dataset.cardsConverted = 'true';
}

let initTimer = null;
function safeInit() {
    clearTimeout(initTimer);
    initTimer = setTimeout(convertTablesToCards, 200);
}

document.addEventListener('DOMContentLoaded', () => safeInit());
document.addEventListener('click', e => {
    if (e.target.closest('.cbi-tab')) safeInit();
});

const observer = new MutationObserver(mutations => {
    let needRun = false;

    for (const m of mutations) {
        if (m.type !== 'attributes' || m.attributeName !== 'style') continue;
        const el = m.target;
        if (!el.classList?.contains('cbi-tabcontainer')) continue;

        const inlineDisplay = el.style.display;
        let isVisible = inlineDisplay === 'block';

        if (!isVisible && !inlineDisplay) {
            const computedDisplay = getComputedStyle(el).display;
            isVisible = computedDisplay === 'block';
        }

        if (isVisible) {
            needRun = true;
            break;
        }
    }

    if (needRun) safeInit();
});

observer.observe(document.body, {
    attributes: true,
    subtree: true,
    attributeFilter: ['style']
});

window.addEventListener('beforeunload', () => {
    clearTimeout(initTimer);
    observer.disconnect();
});
</script>
</body>
</html>
